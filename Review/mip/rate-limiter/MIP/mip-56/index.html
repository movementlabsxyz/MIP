<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>MIP-56: Rate-Limiter for the HTLC-based Native Bridge - MIP</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../../../favicon.svg">
        <link rel="shortcut icon" href="../../../../../favicon.png">
        <link rel="stylesheet" href="../../../../../css/variables.css">
        <link rel="stylesheet" href="../../../../../css/general.css">
        <link rel="stylesheet" href="../../../../../css/chrome.css">
        <link rel="stylesheet" href="../../../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../../../highlight.css">
        <link rel="stylesheet" href="../../../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">MIP</h1>

                    <div class="right-buttons">
                        <a href="../../../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/movementlabsxyz/MIP" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="mip-56-rate-limiter-for-the-htlc-based-native-bridge"><a class="header" href="#mip-56-rate-limiter-for-the-htlc-based-native-bridge">MIP-56: Rate-Limiter for the HTLC-based Native Bridge</a></h1>
<ul>
<li><strong>Description</strong>: A rate limitation mechanism for the HTLC-based Native Bridge.</li>
<li><strong>Authors</strong>: <a href="mailto:andreas.penzkofer@movementlabs.xyz">Andreas Penzkofer</a></li>
</ul>
<h2 id="abstract"><a class="header" href="#abstract">Abstract</a></h2>
<p>The <strong>Rate-Limiter</strong> for the HTLC-based Native Bridge (hereafter called Native Bridge) is introduced to de-escalate the risk of double-spends through the Native Bridge by limiting the number of tokens that can be transferred during a certain time frame. The rate limit is determined by the reaction time of the bridge operator, called the <strong>Risk Period</strong>, and the value locked in the <strong>Security Fund</strong>, see <a href="https://github.com/movementlabsxyz/MIP/pull/50">MIP-50</a>.</p>
<p>The Native Bridge Rate Limiter is implemented through a contract on L1. This contract is governed by the Aptos governance framework, see <a href="https://github.com/movementlabsxyz/MIP/pull/48/">MIP-48</a>, and can be updated through a governance process.</p>
<h2 id="motivation"><a class="header" href="#motivation">Motivation</a></h2>
<p>The correct operation of the Native Bridge relies on liveness and safety assumptions for the relayer, see <a href="https://github.com/movementlabsxyz/MIP/tree/mip/security_falliblity/MIP/mip-46">MIP-13</a>. If any of these would not hold, the Native Bridge could expose the network to double-spends.</p>
<h2 id="specification"><a class="header" href="#specification">Specification</a></h2>
<p>The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “NOT RECOMMENDED”, “MAY”, and “OPTIONAL” in this document are to be interpreted as described in RFC 2119 and RFC 8174.</p>
<p><img src="overview.png" alt="Overview" />
<em>Figure 1: Overview of the Rate-Limiter mechanism for the Native Bridge.</em></p>
<blockquote>
<p>[!NOTE] In the following we note that when talk about the Rate-Limiter, we mean the Rate-Limiter contract.</p>
</blockquote>
<ol>
<li>The Rate-Limiter SHOULD be implemented as a contract on L1.</li>
<li>The Rate-Limiter MUST handle both the <strong>transfer directions</strong> L1 -&gt; L2 and L2 -&gt; L1.</li>
<li>For either transfer direction the transfer value MUST be tracked, i.e. the transferred value for L1-&gt;L2 should be recored in <code>budget_L1L2</code> and for L2-&gt;L1 in <code>budget_L2L1</code>.</li>
<li>The Rate-Limiter SHOULD be governed by the Aptos governance framework, see <a href="https://github.com/movementlabsxyz/MIP/pull/48/">MIP-48</a>, and can be updated through a governance process.</li>
<li>The security fund contract, see <a href="https://github.com/movementlabsxyz/MIP/pull/50">MIP-50</a>, MUST update <code>security_fund</code> in the Rate-Limiter contract if the amount of funds changes in the security fund contract.</li>
<li>The <code>risk_period</code> value SHOULD be set by the governance process and updated through the governance process. It estimates the maximum reaction time to check whether transfers have been completed correctly.</li>
<li>For a given transfer direction, the Rate-Limiter should disable transfers across the bridge if the rate limit is exceeded for that transfer direction.</li>
<li>The rate limit MUST be set according to the equation <code>rate_limit = security_fund / risk_period * 0.5</code>. This is to ensure that each bridge transfer direction is ensured sufficiently.</li>
<li>The Rate-Limiter MUST reject a transfer request if the rate limit is exceeded for that transfer direction by that transaction. I.e. for L1-&gt;L2 the Rate-Limiter MUST reject any transfer that would violate <code>budget_L1L2 &lt; rate_limit</code> and for L2-&gt;L1 the Rate-Limiter MUST reject any transfer that would violate <code>budget_L2L1 &lt; rate_limit</code>.</li>
<li>The rate limitation should be applied at the earliest possible point on L1. For the L1-&gt;L2 transfer direction, according to <a href="https://github.com/movementlabsxyz/MIP/pull/39">MIP-39</a> this is at the <code>init_bridge_transfer</code> function. While, for the L2-&gt;L1 transfer direction, it is the <code>lock_bridge_transfer</code> function.</li>
</ol>
<h3 id="optimization"><a class="header" href="#optimization">Optimization</a></h3>
<ol>
<li>The Rate-Limiter COULD be implemented as a contract on L2 to save on gas costs. However the security of this approach must be carefully evaluated, as the base truth for the protocol is the L1, which entertains ultimate settlement.</li>
<li>The rate limit COULD be unbalanced between the two transfer directions by a factor <code>weight</code><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span>. That is the equations would be <code>rate_limit_L1L2 = security_fund / risk_period * weight</code> and <code>rate_limit_L2L1 = security_fund / risk_period * (1-weight)</code>. This would allow for a more flexible rate limit, if the network experiences higher inflow into or outflow from L2.</li>
<li>The Rate-Limiter COULD consider the budget across both directions as a single budget. This would apply the above equation with a dynamic <code>weight</code>. However this raises the question of the asynchrony of events between the two directions, and such an approach should be analyzed carefully.</li>
<li>The <code>budget_L1L2</code> and <code>budget_L2L1</code> values COULD be reset, if the governance is convinced that all transfers have been processed correctly and are not revertible, however this is risky due to the introduction of human error. Alternatively, an automated approach could be considered that takes into account all completed transfers. However, this is out of scope for this MIP.</li>
<li>Alternatively to the security fund contract updating the <code>security_fund</code> value in the Rate-Limiter contract, the Rate-Limiter contract could read the <code>security_fund</code> value from the security fund contract. However, this raises the question of how regular the Rate-Limiter should update the value, and also it would imply that occasionally the Rate-Limiter could have an outdated value. It is more risky.</li>
<li>Rate limitation could be implemented on both sides of the bridge. This permits to inform the user at the earliest possible point that a transfer is rejected. However, naively, it would require two separate security fund pools (one on L1 and one on L2), and increase the amount of code, as contracts require implementation both on L1 and L2.</li>
</ol>
<h3 id="limitations"><a class="header" href="#limitations">Limitations</a></h3>
<h4 id="security-considerations"><a class="header" href="#security-considerations">Security Considerations</a></h4>
<p>The Governance imposes a risk on the Rate-Limiter, as it could be manipulated by the governance which holds control over the <code>risk_period</code> value. However, the Governance is also responsible for the security fund and other components in the Network. Furthermore the Governance is designed with the intention of moving to a more decentralized design eventually.</p>
<h4 id="bad-user-experience-when-budget-is-nearly-exhausted"><a class="header" href="#bad-user-experience-when-budget-is-nearly-exhausted">Bad user experience when budget is nearly exhausted</a></h4>
<p>If the budget is nearly exhausted, the Rate-Limiter will reject transfers. This could lead to a bad user experience, as users would not be able to transfer tokens across the bridge. However, this is a necessary trade-off to ensure the security of the bridge.</p>
<p>User experience could be improved by having warnings issued by a client that reads the remaining budget from the Rate-Limiter contract. In particular the error <code>RATE_LIMIT_EXCEEDED</code> should be displayed to the user.</p>
<h2 id="reference-implementation"><a class="header" href="#reference-implementation">Reference Implementation</a></h2>
<h2 id="verification"><a class="header" href="#verification">Verification</a></h2>
<p>If the Rate-Limiter handles each transfer direction budget individually, requests for transfers are applied deterministically through the L1 ordering. Thus no asynchronous assumptions are introduced by the Rate-Limiter.</p>
<p>If the Security Fund contract updates the <code>security_fund</code> value in the Rate-Limiter contract, the Rate-Limiter can be sure to have the correct value for the rate limit.</p>
<h2 id="errata"><a class="header" href="#errata">Errata</a></h2>
<h2 id="appendix"><a class="header" href="#appendix">Appendix</a></h2>
<h2 id="copyright"><a class="header" href="#copyright">Copyright</a></h2>
<p>Copyright and related rights waived via <a href="../LICENSE.html">CC0</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../../../Review/l-monninger/the-bilbao-model/MIP/mip-55/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../../../Review/mip/informer/MIP/mip-57/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../../../Review/l-monninger/the-bilbao-model/MIP/mip-55/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../../../Review/mip/informer/MIP/mip-57/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../../../elasticlunr.min.js"></script>
        <script src="../../../../../mark.min.js"></script>
        <script src="../../../../../searcher.js"></script>

        <script src="../../../../../clipboard.min.js"></script>
        <script src="../../../../../highlight.js"></script>
        <script src="../../../../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
